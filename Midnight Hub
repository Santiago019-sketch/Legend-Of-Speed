-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local UserInputService = game:GetService("UserInputService")

-- Variables
local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

-- UI Library
local OrionLib = loadstring(game:HttpGet(('https://raw.githubusercontent.com/shlexware/Orion/main/source')))()

-- Window Creation
local Window = OrionLib:MakeWindow({
    Name = "Midnight Hub | Legend of Speed",
    HidePremium = false,
    SaveConfig = true,
    ConfigFolder = "MidnightConfig",
    IntroEnabled = true,
    IntroText = "Midnight Hub"
})

-- Tabs
local MainTab = Window:MakeTab({
    Name = "Main",
    Icon = "rbxassetid://4483345998",
    PremiumOnly = false
})

local PetsTab = Window:MakeTab({
    Name = "Pets",
    Icon = "rbxassetid://4483345998",
    PremiumOnly = false
})

local ChestsTab = Window:MakeTab({
    Name = "Chests & Crystals",
    Icon = "rbxassetid://4483345998",
    PremiumOnly = false
})

local SettingsTab = Window:MakeTab({
    Name = "Settings",
    Icon = "rbxassetid://4483345998",
    PremiumOnly = false
})

-- Functions
local function CollectOrbs(orbType, area)
    if ReplicatedStorage and ReplicatedStorage:FindFirstChild("rEvents") and ReplicatedStorage.rEvents:FindFirstChild("orbEvent") then
        local args = {
            [1] = "collectOrb",
            [2] = orbType,
            [3] = area
        }
        ReplicatedStorage.rEvents.orbEvent:FireServer(unpack(args))
    end
end

local function AutoCollectAllOrbs()
    local orbTypes = {"Yellow Orb", "Orange Orb", "Red Orb", "Blue Orb"}
    local areas = {"City", "Snow City", "Magma City", "Desert"}
    
    for _, area in ipairs(areas) do
        for _, orbType in ipairs(orbTypes) do
            task.spawn(function()
                CollectOrbs(orbType, area)
            end)
        end
    end
end

local function AutoCollectGems()
    local areas = {"City", "Snow City", "Magma City", "Desert"}
    for _, area in ipairs(areas) do
        task.spawn(function()
            CollectOrbs("Gem", area)
        end)
    end
end

-- New Remote Functions
local function TravelToArea()
    local args = {
        [1] = "travelToArea",
        [2] = workspace.areaCircles.areaCircle
    }
    ReplicatedStorage.rEvents.areaTravelRemote:InvokeServer(unpack(args))
end

local function CollectRewardChest()
    local args = {
        [1] = workspace.rewardChests.rewardChest
    }
    ReplicatedStorage.rEvents.collectCourseChestRemote:InvokeServer(unpack(args))
end

local function OpenCrystal(crystalType)
    local args = {
        [1] = "openCrystal",
        [2] = crystalType
    }
    ReplicatedStorage.rEvents.openCrystalRemote:InvokeServer(unpack(args))
end

local function CheckChest(chestType)
    local args = {
        [1] = chestType
    }
    ReplicatedStorage.rEvents.checkChestRemote:InvokeServer(unpack(args))
end

-- Main Tab
local FarmingSection = MainTab:AddSection({
    Name = "Farming"
})

-- Auto Collect Orbs
FarmingSection:AddToggle({
    Name = "Auto Collect All Orbs",
    Default = false,
    Callback = function(Value)
        getgenv().AutoOrbs = Value
        while getgenv().AutoOrbs and task.wait() do
            pcall(AutoCollectAllOrbs)
        end
    end
})

-- Auto Collect Gems
FarmingSection:AddToggle({
    Name = "Auto Collect Gems",
    Default = false,
    Callback = function(Value)
        getgenv().AutoGems = Value
        while getgenv().AutoGems and task.wait() do
            pcall(AutoCollectGems)
        end
    end
})

-- Safe Hoops Farm
FarmingSection:AddToggle({
    Name = "Safe Hoops Farm",
    Default = false,
    Callback = function(Value)
        getgenv().SafeHoops = Value
        
        if Value then
            HumanoidRootPart.CFrame = CFrame.new(0, 10000, 0)
        end
        
        while getgenv().SafeHoops and task.wait(0.3) do
            pcall(function()
                for _, hoop in pairs(workspace.Hoops:GetChildren()) do
                    if hoop:IsA("BasePart") and getgenv().SafeHoops then
                        hoop.CFrame = HumanoidRootPart.CFrame
                        task.wait(0.3)
                    end
                end
            end)
        end
    end
})

-- Fast Hoops
FarmingSection:AddToggle({
    Name = "Fast Hoops Farm",
    Default = false,
    Callback = function(Value)
        getgenv().FastHoops = Value
        while getgenv().FastHoops and task.wait(0.1) do
            pcall(function()
                for _, hoop in pairs(workspace.Hoops:GetChildren()) do
                    if hoop:IsA("BasePart") then
                        hoop.CFrame = HumanoidRootPart.CFrame
                    end
                end
            end)
        end
    end
})

-- Auto Rebirth
FarmingSection:AddToggle({
    Name = "Auto Rebirth",
    Default = false,
    Callback = function(Value)
        getgenv().AutoRebirth = Value
        while getgenv().AutoRebirth and task.wait(0.5) do
            pcall(function()
                ReplicatedStorage.rEvents.rebirthEvent:FireServer("rebirthRequest")
            end)
        end
    end
})

-- Chests & Crystals Tab
local ChestsSection = ChestsTab:AddSection({
    Name = "Chests and Crystals"
})

-- Auto Check Chests
ChestsSection:AddToggle({
    Name = "Auto Check Chests",
    Default = false,
    Callback = function(Value)
        getgenv().AutoCheckChests = Value
        while getgenv().AutoCheckChests and task.wait(1) do
            pcall(function()
                CheckChest("Magma Chest")
                CheckChest("Enchanted Chest")
                CheckChest("Golden Chest")
            end)
        end
    end
})

-- Auto Open Crystals
ChestsSection:AddToggle({
    Name = "Auto Open Crystals",
    Default = false,
    Callback = function(Value)
        getgenv().AutoOpenCrystals = Value
        while getgenv().AutoOpenCrystals and task.wait(1) do
            pcall(function()
                OpenCrystal("Lightning Crystal")
                OpenCrystal("Blue Crystal")
            end)
        end
    end
})

-- Auto Collect Reward Chests
ChestsSection:AddToggle({
    Name = "Auto Collect Reward Chests",
    Default = false,
    Callback = function(Value)
        getgenv().AutoCollectRewards = Value
        while getgenv().AutoCollectRewards and task.wait(1) do
            pcall(CollectRewardChest)
        end
    end
})

-- Pets Tab
local PetsSection = PetsTab:AddSection({
    Name = "Auto Buy Eggs"
})

local eggTypes = {
    "Basic Egg",
    "Rare Egg",
    "Epic Egg",
    "Legendary Egg",
    "Premium Egg"
}

PetsSection:AddDropdown({
    Name = "Select Egg",
    Default = "Basic Egg",
    Options = eggTypes,
    Callback = function(Value)
        getgenv().SelectedEgg = Value
    end
})

PetsSection:AddToggle({
    Name = "Auto Buy Selected Egg",
    Default = false,
    Callback = function(Value)
        getgenv().AutoBuyEgg = Value
        while getgenv().AutoBuyEgg and task.wait(1) do
            if getgenv().SelectedEgg then
                pcall(function()
                    local args = {
                        [1] = "purchaseEgg",
                        [2] = getgenv().SelectedEgg
                    }
                    ReplicatedStorage.rEvents.eggEvent:FireServer(unpack(args))
                end)
            end
        end
    end
})

-- Settings Tab
local SettingsSection = SettingsTab:AddSection({
    Name = "Settings"
})

SettingsSection:AddButton({
    Name = "Destroy GUI",
    Callback = function()
        OrionLib:Destroy()
    end
})

SettingsSection:AddButton({
    Name = "Rejoin Game",
    Callback = function()
        TeleportService:Teleport(game.PlaceId, Player)
    end
})

-- Initialize
OrionLib:Init()

-- Toggle Key
UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.RightControl then
        OrionLib:ToggleUI()
    end
end)

-- Anti AFK
local VirtualUser = game:GetService("VirtualUser")
Player.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    task.wait(1)
    VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
end)
